apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

/**
 * ROMulus Mobile - Android Build Configuration
 * Supports: Phones, Tablets, Anbernic, Retroid, AYANEO, and other handhelds
 */

import com.android.build.OutputFile

react {
    root = file("../../")
    reactNativeDir = file("../../node_modules/react-native")
    codegenDir = file("../../node_modules/@react-native/codegen")
    cliFile = file("../../node_modules/react-native/cli.js")
    debuggableVariants = ["debug"]
    bundleAssetName = "index.android.bundle"
    entryFile = file("../../index.js")
    hermesCommand = file("../../node_modules/react-native/sdks/hermesc/%OS-BIN%/hermesc").absolutePath
    enableHermesOnlyInVariants = ["release"]
}

def keystorePropertiesFile = rootProject.file("keystore.properties")
def keystoreProperties = new Properties()
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    namespace "com.romulus.mobile"
    compileSdk 34
    ndkVersion "26.1.10909125"
    buildToolsVersion "34.0.0"
    
    defaultConfig {
        applicationId "com.romulus.mobile"
        minSdkVersion 24  // Android 7.0 - supports most handhelds
        targetSdkVersion 34
        versionCode 22
        versionName "2.2.0"
        
        // Multi-architecture support for various handhelds
        ndk {
            abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64"
        }
        
        // Enable large heap for emulation
        largeHeap true
        
        // Hardware acceleration
        hardwareAccelerated true
    }
    
    buildTypes {
        debug {
            debuggable true
            minifyEnabled false
        }
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            
            // Sign with release key
            signingConfig signingConfigs.release
        }
    }
    
    // Handheld-specific build flavors
    flavorDimensions "device"
    productFlavors {
        // Standard Android phones/tablets
        standard {
            dimension "device"
            buildConfigField "String", "DEVICE_TYPE", '"STANDARD"'
        }
        
        // Anbernic devices (RG405M, RG505, etc.)
        anbernic {
            dimension "device"
            applicationIdSuffix ".anbernic"
            buildConfigField "String", "DEVICE_TYPE", '"ANBERNIC"'
            buildConfigField "boolean", "HAS_PHYSICAL_CONTROLS", "true"
            buildConfigField "boolean", "LANDSCAPE_DEFAULT", "true"
        }
        
        // Retroid devices (Pocket 3+, Pocket 4, etc.)
        retroid {
            dimension "device"
            applicationIdSuffix ".retroid"
            buildConfigField "String", "DEVICE_TYPE", '"RETROID"'
            buildConfigField "boolean", "HAS_PHYSICAL_CONTROLS", "true"
            buildConfigField "boolean", "LANDSCAPE_DEFAULT", "true"
        }
        
        // AYANEO devices
        ayaneo {
            dimension "device"
            applicationIdSuffix ".ayaneo"
            buildConfigField "String", "DEVICE_TYPE", '"AYANEO"'
            buildConfigField "boolean", "HAS_PHYSICAL_CONTROLS", "true"
            buildConfigField "boolean", "LANDSCAPE_DEFAULT", "true"
        }
        
        // Logitech G Cloud
        gcloud {
            dimension "device"
            applicationIdSuffix ".gcloud"
            buildConfigField "String", "DEVICE_TYPE", '"GCLOUD"'
            buildConfigField "boolean", "HAS_PHYSICAL_CONTROLS", "true"
        }
        
        // Razer Edge
        razeredge {
            dimension "device"
            applicationIdSuffix ".razeredge"
            buildConfigField "String", "DEVICE_TYPE", '"RAZER_EDGE"'
            buildConfigField "boolean", "HAS_PHYSICAL_CONTROLS", "true"
        }
    }
    
    // Optimization for game streaming
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = '17'
    }
    
    // Enable ViewBinding
    buildFeatures {
        viewBinding true
        buildConfig true
    }
    
    // Packaging options
    packagingOptions {
        pickFirst 'lib/x86/libc++_shared.so'
        pickFirst 'lib/x86_64/libc++_shared.so'
        pickFirst 'lib/armeabi-v7a/libc++_shared.so'
        pickFirst 'lib/arm64-v8a/libc++_shared.so'
    }
}

dependencies {
    // React Native
    implementation project(':react-native')
    
    // WebRTC for streaming
    implementation project(':react-native-webrtc')
    
    // Gamepad support
    implementation 'androidx.games:games-controller:1.1.0'
    implementation 'androidx.games:games-frame-pacing:1.10.0'
    
    // Hardware acceleration
    implementation 'androidx.graphics:graphics-core:1.0.0'
    
    // Keep screen awake
    implementation project(':react-native-keep-awake')
    
    // Orientation control
    implementation project(':react-native-orientation-locker')
    
    // Haptic feedback
    implementation project(':react-native-haptic-feedback')
    
    // Bluetooth for controllers
    implementation 'androidx.bluetooth:bluetooth:1.0.0-alpha02'
    
    // Network
    implementation 'com.squareup.okhttp3:okhttp:4.12.0'
    
    // JSON
    implementation 'com.google.code.gson:gson:2.10.1'
}

// Task to build all handheld variants
task buildAllHandhelds {
    dependsOn 'assembleAnbernicRelease'
    dependsOn 'assembleRetroidRelease'
    dependsOn 'assembleAyaneoRelease'
    dependsOn 'assembleGcloudRelease'
    dependsOn 'assembleRazeredgeRelease'
    dependsOn 'assembleStandardRelease'
}
